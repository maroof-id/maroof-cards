#!/usr/bin/env python3
import nfc
import time

print("?? ?????? AITRIP PN532 - ???? ????????")
print("=" * 60)

# PN532 ???? 3 ??????: UART, I2C, SPI
# ????? ???? ??? CH340 (USB to UART)

transports = [
    # UART modes
    ('tty:/dev/ttyUSB0:pn532', 'UART - ttyUSB0'),
    ('tty:USB0:pn532', 'UART - USB0 short'),
    ('tty:/dev/ttyUSB0', 'UART - Auto detect'),
    
    # USB direct (?? ?? ???? ?? CH340)
    ('usb:1a86:7523', 'USB Direct - CH340 ID'),
    ('usb', 'USB - Auto'),
]

success = False

for transport, description in transports:
    try:
        print(f"\n? ??????: {description}")
        print(f"   ??????: {transport}")
        
        clf = nfc.ContactlessFrontend(transport)
        
        print(f"??? ??? ???????!")
        print(f"?? ??????: {clf}")
        print(f"\n?? ?????? ??? ?? ?????: '{transport}'")
        
        # ?????? ????? ?????
        print(f"\n?? ?? ????? NFC ??? ?????? (5 ?????)...")
        
        start = time.time()
        tag = None
        
        while time.time() - start < 5:
            try:
                tag = clf.connect(rdwr={'on-connect': lambda t: False})
                if tag:
                    break
            except:
                time.sleep(0.1)
        
        if tag:
            print(f"? ????? ??????!")
            print(f"   ?????: {tag}")
            print(f"   UID: {tag.identifier.hex()}")
            
            if tag.ndef:
                print(f"   NDEF: ?????")
                for i, record in enumerate(tag.ndef.records):
                    print(f"   Record {i}: {record}")
        else:
            print(f"?? ?? ??? ?????? ????? (????? ?????)")
        
        clf.close()
        success = True
        break
        
    except Exception as e:
        error_msg = str(e)
        if len(error_msg) > 80:
            error_msg = error_msg[:77] + "..."
        print(f"? ???: {error_msg}")

print("\n" + "=" * 60)

if success:
    print("? ?????? ???? ???? ????!")
else:
    print("? ??? ??????? ??? ???? ????????")
    print("\n?? ???????? ?????:")
    print("   1. ?????? ?? ??? ???? (???? ?? ?????? DIP)")
    print("   2. ???? ???????? ??? ????")
    print("   3. ????? ?? ?????? ?? ???????")
    print("   4. ?????? ????? ????? ?????")
    print("\n?? ????:")
    print("   - ???? ?????? ???? ??????")
    print("   - ???? ?? ?????? DIP (??? ?? ???? ?? ??? HSU/UART)")
    print("   - ???? ???? USB ???")
