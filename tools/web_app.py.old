#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Maroof Web App - Enhanced System
"""

from flask import Flask, request, jsonify, render_template_string, redirect, url_for
import os
import sys
from pathlib import Path
from datetime import datetime

current_dir = Path(__file__).resolve().parent
sys.path.append(str(current_dir))

from create_card import CardGenerator
from nfc_writer import NFCWriter

app = Flask(__name__)
app.config['JSON_AS_ASCII'] = False
app.config['MAX_CONTENT_LENGTH'] = 10 * 1024 * 1024

generator = CardGenerator()

# Notification counter (in-memory, resets on restart)
pending_count = 0

def get_pending_count():
    """Get count of pending cards"""
    cards = generator.list_cards(status_filter='pending')
    return len(cards)

def update_pending_count():
    """Update pending count"""
    global pending_count
    pending_count = get_pending_count()

# Cache-busting version
CACHE_VERSION = datetime.now().strftime('%Y%m%d%H%M%S')

# HTML Templates with modern design
BASE_STYLE = f"""
<style>
    * {{ margin: 0; padding: 0; box-sizing: border-box; }}
    
    :root {{
        --white: #FFFFFF;
        --light-gray: #F5F5F5;
        --gray: #E0E0E0;
        --dark-gray: #757575;
        --black: #212121;
        --success: #4CAF50;
        --warning: #FF9800;
        --error: #F44336;
        --pending: #2196F3;
    }}
    
    body {{
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', sans-serif;
        background: var(--light-gray);
        min-height: 100vh;
        color: var(--black);
        line-height: 1.6;
    }}
    
    .container {{
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }}
    
    .nav {{
        background: var(--white);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        position: sticky;
        top: 0;
        z-index: 100;
    }}
    
    .nav-inner {{
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        padding: 15px 20px;
        gap: 15px;
    }}
    
    .nav-btn {{
        padding: 10px 20px;
        background: var(--white);
        color: var(--black);
        border: 2px solid var(--gray);
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }}
    
    .nav-btn:hover {{
        background: var(--light-gray);
        border-color: var(--dark-gray);
        transform: translateY(-1px);
    }}
    
    .nav-btn.active {{
        background: var(--black);
        color: var(--white);
        border-color: var(--black);
    }}
    
    .notification-badge {{
        background: var(--error);
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 5px;
    }}
    
    .card {{
        background: var(--white);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }}
    
    h1 {{
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 25px;
        color: var(--black);
    }}
    
    h2 {{
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--black);
    }}
    
    .form-group {{
        margin-bottom: 20px;
    }}
    
    label {{
        display: block;
        margin-bottom: 8px;
        color: var(--black);
        font-weight: 500;
        font-size: 14px;
    }}
    
    input, textarea, select {{
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--gray);
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        transition: border-color 0.2s;
        background: var(--white);
    }}
    
    input:focus, textarea:focus, select:focus {{
        outline: none;
        border-color: var(--black);
    }}
    
    textarea {{
        resize: vertical;
        min-height: 100px;
    }}
    
    input[type="file"] {{
        padding: 10px;
        border: 2px dashed var(--gray);
        background: var(--light-gray);
        cursor: pointer;
    }}
    
    input[type="file"]:hover {{
        border-color: var(--dark-gray);
    }}
    
    .btn {{
        padding: 12px 24px;
        background: var(--black);
        color: var(--white);
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }}
    
    .btn:hover {{
        background: #000;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }}
    
    .btn:disabled {{
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }}
    
    .btn-success {{ background: var(--success); }}
    .btn-warning {{ background: var(--warning); }}
    .btn-error {{ background: var(--error); }}
    .btn-secondary {{ background: var(--dark-gray); }}
    
    .btn-outline {{
        background: var(--white);
        color: var(--black);
        border: 2px solid var(--gray);
    }}
    
    .btn-outline:hover {{
        background: var(--light-gray);
        border-color: var(--black);
    }}
    
    .status-indicator {{
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }}
    
    .status-success {{
        background: #e8f5e9;
        color: var(--success);
    }}
    
    .status-warning {{
        background: #fff3e0;
        color: var(--warning);
    }}
    
    .status-error {{
        background: #ffebee;
        color: var(--error);
    }}
    
    .status-pending {{
        background: #e3f2fd;
        color: var(--pending);
    }}
    
    .stats {{
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }}
    
    .stat-card {{
        background: var(--white);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }}
    
    .stat-value {{
        font-size: 32px;
        font-weight: 700;
        color: var(--black);
        margin-bottom: 5px;
    }}
    
    .stat-label {{
        font-size: 14px;
        color: var(--dark-gray);
        font-weight: 500;
    }}
    
    table {{
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }}
    
    th {{
        background: var(--light-gray);
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        color: var(--black);
        border-bottom: 2px solid var(--gray);
    }}
    
    td {{
        padding: 15px 12px;
        border-bottom: 1px solid var(--gray);
        font-size: 14px;
    }}
    
    tr:hover {{
        background: var(--light-gray);
    }}
    
    .photo-preview {{
        margin-top: 15px;
        text-align: center;
    }}
    
    .photo-preview img {{
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        border: 3px solid var(--gray);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }}
    
    .alert {{
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }}
    
    .alert.show {{ display: block; }}
    
    .alert-success {{
        background: #e8f5e9;
        color: var(--success);
        border-left: 4px solid var(--success);
    }}
    
    .alert-error {{
        background: #ffebee;
        color: var(--error);
        border-left: 4px solid var(--error);
    }}
    
    .loading {{
        display: none;
        text-align: center;
        padding: 20px;
    }}
    
    .spinner {{
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid var(--gray);
        border-top: 3px solid var(--black);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }}
    
    @keyframes spin {{
        0% {{ transform: rotate(0deg); }}
        100% {{ transform: rotate(360deg); }}
    }}
    
    .reader-status {{
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
    }}
    
    .reader-status.online {{
        background: #e8f5e9;
        color: var(--success);
    }}
    
    .reader-status.offline {{
        background: #ffebee;
        color: var(--error);
    }}
    
    .status-dot {{
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
    }}
    
    .status-dot.green {{ background: var(--success); }}
    .status-dot.red {{ background: var(--error); }}
    
    @keyframes pulse {{
        0%, 100% {{ opacity: 1; }}
        50% {{ opacity: 0.5; }}
    }}
    
    @media (max-width: 768px) {{
        .container {{ padding: 10px; }}
        .nav-inner {{ flex-wrap: wrap; }}
        .stats {{ grid-template-columns: 1fr; }}
        table {{ font-size: 12px; }}
        th, td {{ padding: 8px; }}
    }}
</style>
"""

HOME_PAGE = f"""
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maroof - ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {BASE_STYLE}
</head>
<body>
    <div class="nav">
        <div class="nav-inner">
            <a href="/" class="nav-btn active">
                <i class="fas fa-plus-circle"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ©
            </a>
            <a href="/dashboard" class="nav-btn" id="dashboardBtn">
                <i class="fas fa-th-large"></i> ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ
                <span class="notification-badge" id="pendingBadge" style="display:none;">0</span>
            </a>
            <a href="/settings" class="nav-btn">
                <i class="fas fa-cog"></i> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            </a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h1>ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ© ÿ¨ÿØŸäÿØÿ©</h1>

            <div id="alert" class="alert"></div>

            <form id="cardForm">
                <div class="form-group">
                    <label>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ *</label>
                    <input type="text" name="name" required placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ">
                </div>

                <div class="form-group">
                    <label>ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ©</label>
                    <input type="file" name="photo" id="photoInput" accept="image/jpeg,image/png,image/gif,image/webp">
                    <small style="color: var(--dark-gray); display: block; margin-top: 5px;">
                        ÿßÿÆÿ™Ÿäÿßÿ±Ÿä - JPG, PNG, GIF (ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 5MB)
                    </small>
                    <div class="photo-preview" id="photoPreview" style="display: none;">
                        <img id="previewImage" src="" alt="ŸÖÿπÿßŸäŸÜÿ©">
                    </div>
                </div>

                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ</label>
                    <input type="tel" name="phone" placeholder="05xxxxxxxx">
                </div>

                <div class="form-group">
                    <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                    <input type="email" name="email" placeholder="example@email.com">
                </div>

                <div class="form-group">
                    <label>Instagram</label>
                    <input type="text" name="instagram" placeholder="username">
                </div>

                <div class="form-group">
                    <label>LinkedIn</label>
                    <input type="text" name="linkedin" placeholder="username">
                </div>

                <div class="form-group">
                    <label>Twitter/X</label>
                    <input type="text" name="twitter" placeholder="username">
                </div>

                <div class="form-group">
                    <label>ŸÜÿ®ÿ∞ÿ© ÿ™ÿπÿ±ŸäŸÅŸäÿ©</label>
                    <textarea name="bio" placeholder="ÿßŸÉÿ™ÿ® ŸÜÿ®ÿ∞ÿ© ÿ™ÿπÿ±ŸäŸÅŸäÿ© ŸÇÿµŸäÿ±ÿ© ÿπŸÜŸÉ"></textarea>
                </div>

                <div class="form-group">
                    <label>ÿßŸÑÿ™ÿµŸÖŸäŸÖ</label>
                    <select name="template">
                        <option value="professional">Professional (ŸÖŸàÿµŸâ ÿ®Ÿá)</option>
                        <option value="luxury">Luxury</option>
                        <option value="friendly">Friendly</option>
                        <option value="modern">Modern</option>
                        <option value="classic">Classic</option>
                        <option value="minimal">Minimal</option>
                    </select>
                </div>

                <button type="submit" class="btn" id="submitBtn">
                    <i class="fas fa-check-circle"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©
                </button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°...</p>
            </div>
        </div>

        <div class="card" id="resultCard" style="display: none;">
            <h2>‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠!</h2>
            <div id="resultContent"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="writeToNFC()">
                    <i class="fas fa-wifi"></i> ŸÉÿ™ÿßÿ®ÿ© ÿπŸÑŸâ NFC
                </button>
                <button class="btn btn-outline" onclick="resetForm()">
                    <i class="fas fa-plus"></i> ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ© ÿ¨ÿØŸäÿØÿ©
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUrl = '';
        let currentUsername = '';

        // Photo preview
        document.getElementById('photoInput').addEventListener('change', function(e) {{
            const file = e.target.files[0];
            if (file) {{
                if (file.size > 5 * 1024 * 1024) {{
                    showAlert('ÿßŸÑÿµŸàÿ±ÿ© ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØÿßŸã! ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 5MB', 'error');
                    e.target.value = '';
                    document.getElementById('photoPreview').style.display = 'none';
                    return;
                }}
                
                const reader = new FileReader();
                reader.onload = function(event) {{
                    document.getElementById('previewImage').src = event.target.result;
                    document.getElementById('photoPreview').style.display = 'block';
                }};
                reader.readAsDataURL(file);
            }} else {{
                document.getElementById('photoPreview').style.display = 'none';
            }}
        }});

        // Form submission
        document.getElementById('cardForm').addEventListener('submit', async (e) => {{
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const photoFile = document.getElementById('photoInput').files[0];
            let photoBase64 = '';
            
            if (photoFile) {{
                if (photoFile.size > 5 * 1024 * 1024) {{
                    showAlert('ÿßŸÑÿµŸàÿ±ÿ© ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØÿßŸã! ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 5MB', 'error');
                    return;
                }}
                
                try {{
                    photoBase64 = await new Promise((resolve, reject) => {{
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(photoFile);
                    }});
                }} catch (error) {{
                    showAlert('ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿµŸàÿ±ÿ©', 'error');
                    return;
                }}
            }}
            
            const data = Object.fromEntries(formData);
            delete data.photo;
            if (photoBase64) {{
                data.photo = photoBase64;
            }}
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('resultCard').style.display = 'none';

            try {{
                const response = await fetch('/api/create', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify(data)
                }});

                const result = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;

                if (result.success) {{
                    currentUrl = result.url;
                    currentUsername = result.username;
                    
                    document.getElementById('resultContent').innerHTML = `
                        <p style="margin: 15px 0;"><strong>ÿßŸÑÿ±ÿßÿ®ÿ∑:</strong></p>
                        <a href="${{result.url}}" target="_blank" style="color: var(--black); word-break: break-all;">
                            ${{result.url}}
                        </a>
                    `;
                    
                    document.getElementById('resultCard').style.display = 'block';
                    document.getElementById('cardForm').reset();
                    document.getElementById('photoPreview').style.display = 'none';
                    
                    showAlert('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
                    
                    window.scrollTo({{ top: document.getElementById('resultCard').offsetTop - 20, behavior: 'smooth' }});
                }} else {{
                    showAlert(result.error || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ', 'error');
                }}
            }} catch (error) {{
                document.getElementById('loading').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                showAlert('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ', 'error');
            }}
        }});

        async function writeToNFC() {{
            if (!currentUrl) return;
            
            showAlert('ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÉÿ™ÿßÿ®ÿ©... ÿ∂ÿπ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© ÿπŸÑŸâ ÿßŸÑŸÇÿßÿ±ÿ¶', 'success');
            
            try {{
                const response = await fetch('/api/nfc/write', {{
                    method: 'POST',
                    headers: {{'Content-Type': 'application/json'}},
                    body: JSON.stringify({{url: currentUrl, username: currentUsername}})
                }});

                const result = await response.json();

                if (result.success) {{
                    showAlert('‚úÖ ÿ™ŸÖÿ™ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
                }} else {{
                    showAlert('‚ùå ŸÅÿ¥ŸÑÿ™ ÿßŸÑŸÉÿ™ÿßÿ®ÿ©: ' + result.message, 'error');
                }}
            }} catch (error) {{
                showAlert('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÇÿßÿ±ÿ¶', 'error');
            }}
        }}

        function resetForm() {{
            document.getElementById('cardForm').reset();
            document.getElementById('resultCard').style.display = 'none';
            document.getElementById('photoPreview').style.display = 'none';
            currentUrl = '';
            currentUsername = '';
            window.scrollTo({{ top: 0, behavior: 'smooth' }});
        }}

        function showAlert(message, type) {{
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${{type}} show`;
            setTimeout(() => {{
                alert.classList.remove('show');
            }}, 5000);
        }}

        // Update pending count
        async function updatePendingCount() {{
            try {{
                const response = await fetch('/api/pending-count');
                const data = await response.json();
                const badge = document.getElementById('pendingBadge');
                if (data.count > 0) {{
                    badge.textContent = data.count;
                    badge.style.display = 'inline-block';
                }} else {{
                    badge.style.display = 'none';
                }}
            }} catch (error) {{
                console.error('Failed to update pending count');
            }}
        }}

        // Update every 10 seconds
        setInterval(updatePendingCount, 10000);
        updatePendingCount();
    </script>
</body>
</html>
"""
# (ÿ™ÿßÿ®ÿπ ÿ®ÿπÿØ HOME_PAGE...)

DASHBOARD_PAGE = f"""
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maroof - ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>







# Routes
@app.route('/')
def index():
    response = app.response_class(
        response=HOME_PAGE,
        mimetype='text/html'
    )
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    return response

@app.route('/dashboard')
def dashboard():
    response = app.response_class(
        response=DASHBOARD_PAGE,
        mimetype='text/html'
    )
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    return response

@app.route('/settings')
def settings():
    response = app.response_class(
        response=SETTINGS_PAGE,
        mimetype='text/html'
    )
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    return response

@app.route('/register')
def register():
    response = app.response_class(
        response=REGISTER_PAGE,
        mimetype='text/html'
    )
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    return response

@app.route('/edit/<username>')
def edit(username):
    response = app.response_class(
        response=EDIT_PAGE,
        mimetype='text/html'
    )
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    return response

# API Routes
@app.route('/api/create', methods=['POST'])
def create_card():
    try:
        data = request.get_json() or {}
        name = (data.get('name') or '').strip()

        if not name:
            return jsonify({'success': False, 'error': 'Name is required'}), 400

        result = generator.create_card(
            name=name,
            phone=data.get('phone', ''),
            email=data.get('email', ''),
            instagram=data.get('instagram', ''),
            linkedin=data.get('linkedin', ''),
            twitter=data.get('twitter', ''),
            bio=data.get('bio', ''),
            template=data.get('template', 'professional'),
            photo=data.get('photo', ''),
            source='admin'
        )

        generator.git_push_background(f"Add card: {name}")

        return jsonify({
            'success': True,
            'url': result['url'],
            'username': result['username'],
            'message': 'Card created successfully'
        }), 201

    except Exception as e:
        return jsonify({'success': False, 'error': f'Error: {str(e)}'}), 500

@app.route('/api/register', methods=['POST'])
def register_card():
    try:
        data = request.get_json() or {}
        name = (data.get('name') or '').strip()

        if not name:
            return jsonify({'success': False, 'error': 'Name is required'}), 400

        result = generator.create_card(
            name=name,
            phone=data.get('phone', ''),
            email=data.get('email', ''),
            bio=data.get('bio', ''),
            template='professional',
            photo=data.get('photo', ''),
            source='client'
        )

        update_pending_count()
        
        generator.git_push_background(f"Client registration: {name}")

        return jsonify({
            'success': True,
            'message': 'Registration successful'
        }), 201

    except Exception as e:
        return jsonify({'success': False, 'error': f'Error: {str(e)}'}), 500

@app.route('/api/cards', methods=['GET'])
def list_cards():
    try:
        cards = generator.list_cards()
        
        stats = {
            'pending': len([c for c in cards if c.get('status') == 'pending']),
            'printed': len([c for c in cards if c.get('status') == 'printed']),
            'modified': len([c for c in cards if c.get('status') == 'modified']),
            'total': len(cards)
        }
        
        return jsonify({'success': True, 'cards': cards, 'stats': stats})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/cards/<username>', methods=['GET'])
def get_card(username):
    try:
        data = generator.get_card_data(username)
        if data:
            return jsonify({'success': True, 'data': data})
        return jsonify({'success': False, 'error': 'Card not found'}), 404
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/cards/<username>', methods=['PUT'])
def update_card(username):
    try:
        data = request.get_json() or {}
        
        result = generator.update_card(
            username=username,
            name=data.get('name'),
            phone=data.get('phone'),
            email=data.get('email'),
            instagram=data.get('instagram'),
            linkedin=data.get('linkedin'),
            twitter=data.get('twitter'),
            bio=data.get('bio'),
            template=data.get('template'),
            photo=data.get('photo')
        )

        generator.git_push_background(f"Update card: {username}")

        return jsonify({'success': True, 'message': 'Card updated'})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/cards/<username>', methods=['DELETE'])
def delete_card(username):
    try:
        if generator.delete_card(username):
            generator.git_push_background(f"Delete card: {username}")
            return jsonify({'success': True})
        return jsonify({'success': False, 'error': 'Card not found'}), 404
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

@app.route('/api/nfc/test', methods=['GET'])
def nfc_test():
    try:
        writer = NFCWriter()
        if writer.connect():
            writer.close()
            return jsonify({'success': True, 'message': 'NFC reader connected and working'})
        return jsonify({'success': False, 'message': 'Failed to connect to NFC reader'}), 503
    except Exception as e:
        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500

@app.route('/api/nfc/write', methods=['POST'])
def nfc_write():
    try:
        data = request.get_json() or {}
        url = data.get('url', '')
        username = data.get('username', '')

        if not url:
            return jsonify({'success': False, 'message': 'URL is required'}), 400

        writer = NFCWriter()
        ok, msg = writer.write_url(url, timeout=15)
        writer.close()

        if ok and username:
            generator.mark_as_printed(username)
            generator.git_push_background(f"Print card: {username}")

        return jsonify({'success': ok, 'message': msg})
    except Exception as e:
        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500

@app.route('/api/nfc/read', methods=['GET'])
def nfc_read():
    try:
        writer = NFCWriter()
        data, msg = writer.read_card(timeout=15)
        writer.close()

        if data:
            return jsonify({'success': True, 'data': data, 'message': msg})
        return jsonify({'success': False, 'message': msg}), 404
    except Exception as e:
        return jsonify({'success': False, 'message': f'Error: {str(e)}'}), 500

@app.route('/api/pending-count', methods=['GET'])
def get_pending_count_api():
    try:
        count = len(generator.list_cards(status_filter='pending'))
        return jsonify({'count': count})
    except:
        return jsonify({'count': 0})

if __name__ == '__main__':
    print("=" * 50)
    print("üöÄ Maroof NFC System Starting...")
    print("=" * 50)
    print(f"üì° Server: http://0.0.0.0:7070")
    print(f"üì± Register: http://0.0.0.0:7070/register")
    print(f"üìä Dashboard: http://0.0.0.0:7070/dashboard")
    print(f"‚öôÔ∏è  Settings: http://0.0.0.0:7070/settings")
    print(f"üé® Cache version: {CACHE_VERSION}")
    print("=" * 50)
    app.run(host='0.0.0.0', port=7070, debug=False)