{% extends "pages/base.html" %}

{% block title %}Maroof - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block body %}
<div class="nav">
    <div class="nav-inner">
        <a href="/" class="nav-btn">
            <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø©
        </a>
        <a href="/dashboard" class="nav-btn active">
            <i class="fas fa-th-large"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            <span class="notification-badge" id="pendingBadge" style="display:none;">0</span>
        </a>
        <a href="/settings" class="nav-btn">
            <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </a>
    </div>
</div>

<div class="container">
    <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>

    <div class="stats" id="stats">
        <div class="stat-card">
            <div class="stat-value" id="pendingCount">0</div>
            <div class="stat-label">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="printedCount">0</div>
            <div class="stat-label">âœ… Ù…Ø·Ø¨ÙˆØ¹Ø©</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="modifiedCount">0</div>
            <div class="stat-label">ğŸ“ Ù…Ø¹Ø¯Ù‘Ù„Ø©</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalCount">0</div>
            <div class="stat-label">ğŸ“‡ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
        </div>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <h2>ğŸ“‹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</h2>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„" 
                       style="width: 250px;" onkeyup="filterCards()">
                <select id="statusFilter" onchange="filterCards()" style="width: 150px;">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                    <option value="printed">âœ… Ù…Ø·Ø¨ÙˆØ¹Ø©</option>
                    <option value="modified">ğŸ“ Ù…Ø¹Ø¯Ù‘Ù„Ø©</option>
                </select>
            </div>
        </div>

        <div id="loading" class="loading" style="display: block;">
            <div class="spinner"></div>
            <p style="margin-top: 10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>

        <div id="tableContainer" style="display: none; overflow-x: auto;">
            <table id="cardsTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="cardsBody"></tbody>
            </table>
        </div>

        <div id="emptyState" style="display: none; text-align: center; padding: 40px; color: var(--dark-gray);">
            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allCards = [];

async function loadCards() {
    try {
        const response = await fetch('/api/cards');
        const data = await response.json();
        
        if (data.success) {
            allCards = data.cards;
            updateStats(data.stats);
            renderCards(allCards);
            document.getElementById('loading').style.display = 'none';
            
            if (allCards.length > 0) {
                document.getElementById('tableContainer').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';
            } else {
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Failed to load cards:', error);
        document.getElementById('loading').style.display = 'none';
    }
}

function updateStats(stats) {
    document.getElementById('pendingCount').textContent = stats.pending;
    document.getElementById('printedCount').textContent = stats.printed;
    document.getElementById('modifiedCount').textContent = stats.modified;
    document.getElementById('totalCount').textContent = stats.total;
    
    const badge = document.getElementById('pendingBadge');
    if (stats.pending > 0) {
        badge.textContent = stats.pending;
        badge.style.display = 'inline-block';
    } else {
        badge.style.display = 'none';
    }
}

function renderCards(cards) {
    const tbody = document.getElementById('cardsBody');
    tbody.innerHTML = '';
    
    cards.forEach(card => {
        const tr = document.createElement('tr');
        
        let statusBadge = '';
        if (card.status === 'pending') {
            statusBadge = '<span class="status-indicator status-pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>';
        } else if (card.status === 'printed') {
            statusBadge = '<span class="status-indicator status-success">âœ… Ù…Ø·Ø¨ÙˆØ¹Ø©</span>';
        } else if (card.status === 'modified') {
            statusBadge = '<span class="status-indicator status-warning">ğŸ“ Ù…Ø¹Ø¯Ù‘Ù„Ø©</span>';
        }
        
        const source = card.source === 'client' ? 'ğŸ‘¤ Ø¹Ù…ÙŠÙ„' : 'âš™ï¸ Ø¥Ø¯Ø§Ø±Ø©';
        const date = card.created_at ? new Date(card.created_at).toLocaleDateString('ar-SA') : '-';
        
        tr.innerHTML = `
            <td><strong>${card.name}</strong></td>
            <td>${card.phone || '-'}</td>
            <td>${statusBadge}</td>
            <td>${source}</td>
            <td>${card.print_count}x</td>
            <td>${date}</td>
            <td>
                <div style="display: flex; gap: 5px;">
                    <button class="btn btn-outline" style="padding: 6px 12px; font-size: 13px;" 
                            onclick="viewCard('${card.url}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline" style="padding: 6px 12px; font-size: 13px;" 
                            onclick="editCard('${card.username}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-success" style="padding: 6px 12px; font-size: 13px;" 
                            onclick="printCard('${card.username}', '${card.url}')">
                        <i class="fas fa-print"></i>
                    </button>
                    <button class="btn btn-error" style="padding: 6px 12px; font-size: 13px;" 
                            onclick="deleteCard('${card.username}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function filterCards() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const status = document.getElementById('statusFilter').value;
    
    let filtered = allCards;
    
    if (status !== 'all') {
        filtered = filtered.filter(card => card.status === status);
    }
    
    if (search) {
        filtered = filtered.filter(card => 
            card.name.toLowerCase().includes(search) || 
            (card.phone && card.phone.includes(search))
        );
    }
    
    renderCards(filtered);
}

function viewCard(url) {
    window.open(url, '_blank');
}

function editCard(username) {
    window.location.href = `/edit/${username}`;
}

async function printCard(username, url) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ÙƒØªØ§Ø¨Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù„Ù‰ NFCØŸ')) return;
    
    try {
        const response = await fetch('/api/nfc/write', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url: url, username: username})
        });

        const result = await response.json();

        if (result.success) {
            alert('âœ… ØªÙ…Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            loadCards();
        } else {
            alert('âŒ ÙØ´Ù„Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©: ' + result.message);
        }
    } catch (error) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ø§Ø±Ø¦');
    }
}

async function deleteCard(username) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ')) return;
    
    try {
        const response = await fetch(`/api/cards/${username}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
            loadCards();
        } else {
            alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
        }
    } catch (error) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
    }
}

setInterval(loadCards, 30000);
loadCards();
</script>
{% endblock %}
