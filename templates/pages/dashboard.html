{% extends "base.html" %}

{% block title %}Maroof - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block body %}
<div class="nav">
    <div class="nav-inner">
        <a href="/" class="nav-btn">
            <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø©
        </a>
        <a href="/dashboard" class="nav-btn active">
            <i class="fas fa-th-large"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <a href="/settings" class="nav-btn">
            <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </a>
    </div>
</div>

<div class="container">
    <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>

    <!-- Search Bar -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid var(--light-gray); border-radius: 8px; font-size: 16px;">
            <button onclick="scanCard()" class="btn" style="background: var(--primary); white-space: nowrap;">
                <i class="fas fa-wifi"></i> Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø©
            </button>
        </div>
        <div id="scanLoading" style="display: none; margin-top: 15px; text-align: center;">
            <div class="spinner" style="margin: 0 auto 10px;"></div>
            <p style="color: var(--primary);">Ø¶Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø±Ø¦...</p>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #fff3cd;">ğŸ“‹</div>
            <div class="stat-info">
                <span class="stat-value" id="statTotal">-</span>
                <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #d1ecf1;">â³</div>
            <div class="stat-info">
                <span class="stat-value" id="statPending">-</span>
                <span class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #d4edda;">âœ…</div>
            <div class="stat-info">
                <span class="stat-value" id="statPrinted">-</span>
                <span class="stat-label">ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #f8d7da;">âœï¸</div>
            <div class="stat-info">
                <span class="stat-value" id="statModified">-</span>
                <span class="stat-label">Ù…Ø¹Ø¯Ù‘Ù„Ø©</span>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterCards('all')">Ø§Ù„ÙƒÙ„</button>
        <button class="filter-tab" onclick="filterCards('pending')">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
        <button class="filter-tab" onclick="filterCards('printed')">Ù…Ø·Ø¨ÙˆØ¹Ø©</button>
        <button class="filter-tab" onclick="filterCards('modified')">Ù…Ø¹Ø¯Ù‘Ù„Ø©</button>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <div id="cardsContainer"></div>
    <div id="noResults" style="display: none; text-align: center; padding: 40px; color: var(--dark-gray);">
        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 15px;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-info {
    display: flex;
    flex-direction: column;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary);
}

.stat-label {
    font-size: 13px;
    color: var(--dark-gray);
}

.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    overflow-x: auto;
    padding-bottom: 5px;
}

.filter-tab {
    padding: 10px 20px;
    border: 2px solid var(--light-gray);
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.3s;
}

.filter-tab.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.card-item {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 15px;
    transition: transform 0.2s;
}

.card-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.card-title {
    font-size: 20px;
    font-weight: bold;
    color: var(--primary);
}

.card-status {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
}

.status-pending {
    background: #d1ecf1;
    color: #0c5460;
}

.status-printed {
    background: #d4edda;
    color: #155724;
}

.status-modified {
    background: #f8d7da;
    color: #721c24;
}

.card-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
    padding: 15px;
    background: var(--light-gray);
    border-radius: 8px;
}

.card-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.card-actions button {
    flex: 1;
    min-width: 100px;
    padding: 10px;
    font-size: 14px;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .stat-card {
        padding: 15px;
        gap: 10px;
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    .stat-value {
        font-size: 20px;
    }
    
    .stat-label {
        font-size: 11px;
    }
    
    .card-item {
        padding: 15px;
    }
    
    .card-title {
        font-size: 18px;
    }
    
    .card-info {
        grid-template-columns: 1fr;
        gap: 8px;
        font-size: 14px;
    }
    
    .card-actions {
        flex-direction: column;
    }
    
    .card-actions button {
        width: 100%;
    }
}
</style>

{% endblock %}

{% block extra_js %}
<script>
let allCards = [];
let currentFilter = 'all';

async function loadCards() {
    document.getElementById('loading').style.display = 'block';
    
    try {
        const response = await fetch('/api/cards');
        const result = await response.json();
        
        if (result.success) {
            allCards = result.cards;
            updateStats(result.stats);
            displayCards(allCards);
        }
    } catch (error) {
        console.error('Error loading cards:', error);
    }
    
    document.getElementById('loading').style.display = 'none';
}

function updateStats(stats) {
    document.getElementById('statTotal').textContent = stats.total;
    document.getElementById('statPending').textContent = stats.pending;
    document.getElementById('statPrinted').textContent = stats.printed;
    document.getElementById('statModified').textContent = stats.modified;
}

function displayCards(cards) {
    const container = document.getElementById('cardsContainer');
    const noResults = document.getElementById('noResults');
    
    if (cards.length === 0) {
        container.innerHTML = '';
        noResults.style.display = 'block';
        return;
    }
    
    noResults.style.display = 'none';
    
    container.innerHTML = cards.map(card => `
        <div class="card-item">
            <div class="card-header">
                <div class="card-title">${card.name}</div>
                <span class="card-status status-${card.status}">
                    ${card.status === 'pending' ? 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 
                      card.status === 'printed' ? 'âœ… Ù…Ø·Ø¨ÙˆØ¹Ø©' : 'âœï¸ Ù…Ø¹Ø¯Ù‘Ù„Ø©'}
                </span>
            </div>
            
            <div class="card-info">
                ${card.phone ? `<div>ğŸ“ ${card.phone}</div>` : ''}
                ${card.email ? `<div>ğŸ“§ ${card.email}</div>` : ''}
                <div>ğŸ“… ${new Date(card.created_at).toLocaleDateString('ar-SA')}</div>
                <div>ğŸ–¨ï¸ ${card.print_count || 0} Ù…Ø±Ø§Øª</div>
            </div>
            
            <div class="card-actions">
                <button class="btn btn-outline" onclick="window.open('${card.url}', '_blank')">
                    <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                </button>
                <button class="btn btn-outline" onclick="window.location.href='/edit/${card.username}'">
                    <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                </button>
                <button class="btn btn-warning" onclick="printCard('${card.url}', '${card.username}')">
                    <i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©
                </button>
                <button class="btn btn-danger" onclick="deleteCard('${card.username}')">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
            </div>
        </div>
    `).join('');
}

function filterCards(status) {
    currentFilter = status;
    
    // Update active tab
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Filter and display
    const filtered = status === 'all' ? allCards : allCards.filter(c => c.status === status);
    displayCards(filtered);
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase();
    
    let filtered = currentFilter === 'all' ? allCards : allCards.filter(c => c.status === currentFilter);
    
    if (query) {
        filtered = filtered.filter(card => 
            card.name.toLowerCase().includes(query) ||
            (card.phone && card.phone.includes(query)) ||
            (card.email && card.email.toLowerCase().includes(query))
        );
    }
    
    displayCards(filtered);
});

async function scanCard() {
    const scanBtn = event.target;
    scanBtn.disabled = true;
    document.getElementById('scanLoading').style.display = 'block';
    
    try {
        const response = await fetch('/api/nfc/read');
        const result = await response.json();
        
        document.getElementById('scanLoading').style.display = 'none';
        scanBtn.disabled = false;
        
        if (result.success && result.data && result.data.url) {
            // Extract username from URL
            const match = result.data.url.match(/clients\/([^\/]+)\/?$/);
            if (match) {
                const username = match[1];
                document.getElementById('searchInput').value = username;
                
                // Trigger search
                const filtered = allCards.filter(card => card.username === username);
                if (filtered.length > 0) {
                    displayCards(filtered);
                } else {
                    alert('Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
                }
            }
        } else {
            alert('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
    } catch (error) {
        document.getElementById('scanLoading').style.display = 'none';
        scanBtn.disabled = false;
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
}

async function printCard(url, username) {
    if (!confirm('Ø·Ø¨Ø§Ø¹Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ')) return;
    
    try {
        const response = await fetch('/api/nfc/write', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url, username })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ØªÙ…Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            loadCards();
        } else {
            alert('âŒ ' + result.message);
        }
    } catch (error) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
}

async function deleteCard(username) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ')) return;
    
    try {
        const response = await fetch(`/api/cards/${username}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
            loadCards();
        } else {
            alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
        }
    } catch (error) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
    }
}

loadCards();
setInterval(loadCards, 30000); // Refresh every 30 seconds
</script>
{% endblock %}