{% extends "base.html" %}

{% block title %}Maroof - Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª{% endblock %}

{% block body %}
<div class="nav">
    <div class="nav-inner">
        <a href="/" class="nav-btn">
            <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø©
        </a>
        <a href="/dashboard" class="nav-btn">
            <i class="fas fa-th-large"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            <span class="notification-badge" id="pendingBadge" style="display:none;">0</span>
        </a>
        <a href="/settings" class="nav-btn active">
            <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </a>
    </div>
</div>

<div class="container">
    <h1>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ø±Ø¦</h1>

    <div class="card">
        <h2>Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø±Ø¦</h2>
        <div id="readerStatus" class="reader-status offline" style="margin: 20px 0;">
            <span class="status-dot red"></span>
            <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
        </div>
        
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-warning" onclick="testReader()" id="testBtn">
                <i class="fas fa-stethoscope"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦
            </button>
            <button class="btn btn-secondary" onclick="resetReader()" id="resetBtn">
                <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù‚Ø§Ø±Ø¦
            </button>
            <button class="btn btn-outline" onclick="readCard()" id="readBtn">
                <i class="fas fa-book"></i> Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø·Ø§Ù‚Ø©
            </button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p id="loadingText" style="margin-top: 10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
        </div>

        <div id="result" style="margin-top: 20px; display: none;">
            <h3 id="resultTitle" style="margin-bottom: 10px;"></h3>
            <pre id="resultContent" style="background: var(--light-gray); padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px;"></pre>
        </div>
    </div>

    <div class="card" id="readResultCard" style="display: none;">
        <h2>ğŸ“– Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©</h2>
        <div id="readResult"></div>
        <button class="btn" onclick="useReadData()" style="margin-top: 15px;">
            <i class="fas fa-copy"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        </button>
    </div>

    <div class="card" style="background: #fff3cd; border-left: 4px solid var(--warning);">
        <h3 style="color: var(--warning); margin-bottom: 10px;">ğŸ’¡ Ù†ØµØ§Ø¦Ø­</h3>
        <ul style="margin-right: 20px; line-height: 1.8;">
            <li>Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ø§Ø±Ø¦ØŒ Ø§ÙØµÙ„Ù‡ Ù…Ù† USB ÙˆØ£Ø¹Ø¯ ØªÙˆØµÙŠÙ„Ù‡</li>
            <li>Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø·Ø§Ù‚Ø§Øª NTAG213/215/216 Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</li>
            <li>ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø±Ø¦</li>
            <li>Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù‚Ø¨Ù„ Ø±ÙØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let readData = null;

async function checkReaderStatus() {
    try {
        const response = await fetch('/api/nfc/test');
        const result = await response.json();
        
        const statusDiv = document.getElementById('readerStatus');
        if (result.success) {
            statusDiv.className = 'reader-status online';
            statusDiv.innerHTML = '<span class="status-dot green"></span><span>ğŸŸ¢ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²</span>';
        } else {
            statusDiv.className = 'reader-status offline';
            statusDiv.innerHTML = '<span class="status-dot red"></span><span>ğŸ”´ Ø§Ù„Ù‚Ø§Ø±Ø¦ ØºÙŠØ± Ù…ØªØµÙ„</span>';
        }
    } catch (error) {
        const statusDiv = document.getElementById('readerStatus');
        statusDiv.className = 'reader-status offline';
        statusDiv.innerHTML = '<span class="status-dot red"></span><span>ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</span>';
    }
}

async function testReader() {
    const testBtn = document.getElementById('testBtn');
    testBtn.disabled = true;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loadingText').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...';
    document.getElementById('result').style.display = 'none';

    try {
        const response = await fetch('/api/nfc/test');
        const result = await response.json();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        testBtn.disabled = false;

        if (result.success) {
            document.getElementById('resultTitle').textContent = 'âœ… Ø§Ù„Ù‚Ø§Ø±Ø¦ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­';
            document.getElementById('resultTitle').style.color = 'var(--success)';
            document.getElementById('resultContent').textContent = result.message;
            checkReaderStatus();
        } else {
            document.getElementById('resultTitle').textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ø§Ø±Ø¦';
            document.getElementById('resultTitle').style.color = 'var(--error)';
            document.getElementById('resultContent').textContent = result.message + '\n\nØ§ÙØµÙ„ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ù…Ù† USB ÙˆØ£Ø¹Ø¯ ØªÙˆØµÙŠÙ„Ù‡';
            checkReaderStatus();
        }
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('resultTitle').textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        document.getElementById('resultTitle').style.color = 'var(--error)';
        document.getElementById('resultContent').textContent = error.toString();
        testBtn.disabled = false;
    }
}

async function resetReader() {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù‚Ø§Ø±Ø¦?\n\nØ§ÙØµÙ„ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ù…Ù† USB Ø«Ù… Ø§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚')) return;
    
    alert('Ø§Ù„Ø¢Ù† Ø£Ø¹Ø¯ ØªÙˆØµÙŠÙ„ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø¨Ù€ USB');
    
    setTimeout(() => {
        testReader();
    }, 3000);
}

async function readCard() {
    const readBtn = document.getElementById('readBtn');
    readBtn.disabled = true;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loadingText').textContent = 'Ø¶Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø±Ø¦...';
    document.getElementById('result').style.display = 'none';
    document.getElementById('readResultCard').style.display = 'none';

    try {
        const response = await fetch('/api/nfc/read');
        const result = await response.json();

        document.getElementById('loading').style.display = 'none';
        readBtn.disabled = false;

        if (result.success && result.data) {
            document.getElementById('result').style.display = 'block';
            document.getElementById('resultTitle').textContent = 'âœ… ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù†Ø¬Ø§Ø­';
            document.getElementById('resultTitle').style.color = 'var(--success)';
            document.getElementById('resultContent').textContent = JSON.stringify(result.data, null, 2);
            
            readData = result.data;
            displayReadData(result.data);
        } else {
            document.getElementById('result').style.display = 'block';
            document.getElementById('resultTitle').textContent = 'âŒ ÙØ´Ù„Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©';
            document.getElementById('resultTitle').style.color = 'var(--error)';
            document.getElementById('resultContent').textContent = result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        }
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('resultTitle').textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
        document.getElementById('resultTitle').style.color = 'var(--error)';
        document.getElementById('resultContent').textContent = error.toString();
        readBtn.disabled = false;
    }
}

function displayReadData(data) {
    let html = '<div style="background: var(--light-gray); padding: 15px; border-radius: 8px;">';
    html += `<p><strong>UID:</strong> ${data.uid}</p>`;
    if (data.url) {
        html += `<p><strong>Ø§Ù„Ø±Ø§Ø¨Ø·:</strong> <a href="${data.url}" target="_blank">${data.url}</a></p>`;
    }
    if (data.type) {
        html += `<p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${data.type}</p>`;
    }
    html += '</div>';
    
    document.getElementById('readResult').innerHTML = html;
    document.getElementById('readResultCard').style.display = 'block';
}

function useReadData() {
    if (!readData || !readData.url) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
        return;
    }
    
    const match = readData.url.match(/clients\/([^\/]+)\/?$/);
    if (match) {
        const username = match[1];
        window.location.href = `/edit/${username}`;
    } else {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©');
    }
}

checkReaderStatus();
setInterval(checkReaderStatus, 30000);
</script>
{% endblock %}
