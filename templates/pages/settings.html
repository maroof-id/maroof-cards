{% extends "base.html" %}

{% block title %}Maroof - Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª{% endblock %}

{% block body %}
<div class="nav">
    <div class="nav-inner">
        <a href="/" class="nav-btn">
            <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø©
        </a>
        <a href="/dashboard" class="nav-btn">
            <i class="fas fa-th-large"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </a>
        <a href="/settings" class="nav-btn active">
            <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </a>
    </div>
</div>

<div class="container">
    <h1>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ø±Ø¦</h1>

    <div class="card">
        <h2>Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø±Ø¦</h2>
        <div id="readerStatus" class="reader-status offline" style="margin: 20px 0;">
            <span class="status-dot red"></span>
            <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</span>
        </div>
        
        <div class="button-group">
            <button class="btn btn-warning" onclick="testReader()" id="testBtn">
                <i class="fas fa-stethoscope"></i> Ø§Ø®ØªØ¨Ø§Ø±
            </button>
            <button class="btn btn-secondary" onclick="resetReader()" id="resetBtn">
                <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
            </button>
            <button class="btn btn-outline" onclick="readCard()" id="readBtn">
                <i class="fas fa-book"></i> Ù‚Ø±Ø§Ø¡Ø©
            </button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p id="loadingText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
        </div>

        <div id="result" style="margin-top: 20px; display: none;">
            <h3 id="resultTitle"></h3>
            <pre id="resultContent"></pre>
        </div>
    </div>

    <div class="card" id="readResultCard" style="display: none;">
        <h2>ğŸ“– Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h2>
        <div id="readResult"></div>
        <button class="btn" onclick="useReadData()">
            <i class="fas fa-copy"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
    </div>

    <div class="card tips-card">
        <h3>ğŸ’¡ Ù†ØµØ§Ø¦Ø­</h3>
        <ul>
            <li>Ø§ÙØµÙ„ Ø§Ù„Ù‚Ø§Ø±Ø¦ ÙˆØ£Ø¹Ø¯ ØªÙˆØµÙŠÙ„Ù‡ Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„</li>
            <li>Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø·Ø§Ù‚Ø§Øª NTAG213/215/216</li>
            <li>Ø¶Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø±Ø¦</li>
        </ul>
    </div>
</div>

<style>
.button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.button-group button {
    flex: 1;
    min-width: 100px;
}

.tips-card {
    background: #fff3cd;
    border-left: 4px solid var(--warning);
}

.tips-card h3 {
    color: var(--warning);
    margin-bottom: 10px;
}

.tips-card ul {
    margin-right: 20px;
    line-height: 1.8;
}

@media (max-width: 768px) {
    .button-group {
        flex-direction: column;
    }
    
    .button-group button {
        width: 100%;
    }
    
    #resultContent {
        font-size: 11px;
        overflow-x: auto;
    }
}
</style>

{% endblock %}

{% block extra_js %}
<script>
let readData = null;

async function checkReaderStatus() {
    try {
        const response = await fetch('/api/nfc/test');
        const result = await response.json();
        
        const statusDiv = document.getElementById('readerStatus');
        if (result.success) {
            statusDiv.className = 'reader-status online';
            statusDiv.innerHTML = '<span class="status-dot green"></span><span>ğŸŸ¢ Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²</span>';
        } else {
            statusDiv.className = 'reader-status offline';
            statusDiv.innerHTML = '<span class="status-dot red"></span><span>ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„</span>';
        }
    } catch (error) {
        const statusDiv = document.getElementById('readerStatus');
        statusDiv.className = 'reader-status offline';
        statusDiv.innerHTML = '<span class="status-dot red"></span><span>ğŸ”´ Ø®Ø·Ø£</span>';
    }
}

async function testReader() {
    const testBtn = document.getElementById('testBtn');
    testBtn.disabled = true;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('result').style.display = 'none';

    try {
        const response = await fetch('/api/nfc/test');
        const result = await response.json();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        testBtn.disabled = false;

        if (result.success) {
            document.getElementById('resultTitle').textContent = 'âœ… Ø§Ù„Ù‚Ø§Ø±Ø¦ ÙŠØ¹Ù…Ù„';
            document.getElementById('resultTitle').style.color = 'var(--success)';
            document.getElementById('resultContent').textContent = result.message;
            checkReaderStatus();
        } else {
            document.getElementById('resultTitle').textContent = 'âŒ ÙØ´Ù„';
            document.getElementById('resultTitle').style.color = 'var(--error)';
            document.getElementById('resultContent').textContent = result.message;
            checkReaderStatus();
        }
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('resultTitle').textContent = 'âŒ Ø®Ø·Ø£';
        document.getElementById('resultTitle').style.color = 'var(--error)';
        document.getElementById('resultContent').textContent = error.toString();
        testBtn.disabled = false;
    }
}

async function resetReader() {
    if (!confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù‚Ø§Ø±Ø¦ØŸ')) return;
    alert('Ø§ÙØµÙ„ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ù…Ù† USB Ø«Ù… Ø£Ø¹Ø¯ ØªÙˆØµÙŠÙ„Ù‡');
    setTimeout(testReader, 3000);
}

async function readCard() {
    const readBtn = document.getElementById('readBtn');
    readBtn.disabled = true;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loadingText').textContent = 'Ø¶Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø±Ø¦...';
    document.getElementById('result').style.display = 'none';
    document.getElementById('readResultCard').style.display = 'none';

    try {
        const response = await fetch('/api/nfc/read');
        const result = await response.json();

        document.getElementById('loading').style.display = 'none';
        readBtn.disabled = false;

        if (result.success && result.data) {
            document.getElementById('result').style.display = 'block';
            document.getElementById('resultTitle').textContent = 'âœ… Ù†Ø¬Ø­';
            document.getElementById('resultTitle').style.color = 'var(--success)';
            document.getElementById('resultContent').textContent = JSON.stringify(result.data, null, 2);
            
            readData = result.data;
            displayReadData(result.data);
        } else {
            document.getElementById('result').style.display = 'block';
            document.getElementById('resultTitle').textContent = 'âŒ ÙØ´Ù„';
            document.getElementById('resultTitle').style.color = 'var(--error)';
            document.getElementById('resultContent').textContent = result.message;
        }
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('resultTitle').textContent = 'âŒ Ø®Ø·Ø£';
        document.getElementById('resultTitle').style.color = 'var(--error)';
        document.getElementById('resultContent').textContent = error.toString();
        readBtn.disabled = false;
    }
}

function displayReadData(data) {
    let html = '<div style="background: var(--light-gray); padding: 15px; border-radius: 8px;">';
    html += `<p><strong>UID:</strong> ${data.uid}</p>`;
    if (data.url) {
        html += `<p><strong>Ø§Ù„Ø±Ø§Ø¨Ø·:</strong> <a href="${data.url}" target="_blank">${data.url}</a></p>`;
    }
    html += '</div>';
    
    document.getElementById('readResult').innerHTML = html;
    document.getElementById('readResultCard').style.display = 'block';
}

function useReadData() {
    if (!readData || !readData.url) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª');
        return;
    }
    
    const match = readData.url.match(/clients\/([^\/]+)\/?$/);
    if (match) {
        window.location.href = `/edit/${match[1]}`;
    } else {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©');
    }
}

checkReaderStatus();
setInterval(checkReaderStatus, 30000);
</script>
{% endblock %}
