{% extends "pages/base.html" %}

{% block title %}Maroof - ØªØ³Ø¬ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø©{% endblock %}

{% block body %}
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 0;">
    <div class="container" style="max-width: 600px;">
        <div class="card" style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‘‹</div>
            <h1 style="margin-bottom: 10px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h1>
            <p style="color: var(--dark-gray); margin-bottom: 30px;">Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚ØªÙƒ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</p>

            <div id="alert" class="alert"></div>

            <form id="registerForm" style="text-align: right;">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                    <input type="text" name="name" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
                    <input type="file" name="photo" id="photoInput" accept="image/jpeg,image/png,image/gif,image/webp">
                    <small style="color: var(--dark-gray); display: block; margin-top: 5px;">
                        Ø§Ø®ØªÙŠØ§Ø±ÙŠ - JPG, PNG (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB)
                    </small>
                    <div class="photo-preview" id="photoPreview" style="display: none;">
                        <img id="previewImage" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                    </div>
                </div>

                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ *</label>
                    <input type="tel" name="phone" required placeholder="05xxxxxxxx">
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" name="email" placeholder="example@email.com">
                </div>

                <div class="form-group">
                    <label>Ù†Ø¨Ø°Ø© ØªØ¹Ø±ÙŠÙÙŠØ©</label>
                    <textarea name="bio" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù†Ùƒ" rows="3"></textarea>
                </div>

                <button type="submit" class="btn" id="submitBtn" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...</p>
            </div>
        </div>

        <div class="card" id="successCard" style="display: none; text-align: center; background: #e8f5e9;">
            <div style="font-size: 64px; margin-bottom: 15px;">âœ…</div>
            <h2 style="color: var(--success); margin-bottom: 10px;">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!</h2>
            <p style="color: var(--dark-gray);">Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø·Ø§Ù‚ØªÙƒ</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Photo preview
document.getElementById('photoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            showAlert('Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB', 'error');
            e.target.value = '';
            document.getElementById('photoPreview').style.display = 'none';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
            document.getElementById('previewImage').src = event.target.result;
            document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('photoPreview').style.display = 'none';
    }
});

// Form submission
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const photoFile = document.getElementById('photoInput').files[0];
    let photoBase64 = '';
    
    if (photoFile) {
        if (photoFile.size > 5 * 1024 * 1024) {
            showAlert('Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB', 'error');
            return;
        }
        
        try {
            photoBase64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(photoFile);
            });
        } catch (error) {
            showAlert('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©', 'error');
            return;
        }
    }
    
    const data = Object.fromEntries(formData);
    delete data.photo;
    if (photoBase64) {
        data.photo = photoBase64;
    }
    data.source = 'client';
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('submitBtn').disabled = true;

    try {
        const response = await fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const result = await response.json();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;

        if (result.success) {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('successCard').style.display = 'block';
        } else {
            showAlert(result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', 'error');
        }
    } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    }
});
</script>
{% endblock %}
